<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sustainability Dashboard (Live)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f6; color: #333; margin: 0; padding: 20px; }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; grid-gap: 20px; max-width: 1200px; margin: 0 auto; }
        .card { background-color: #fff; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); padding: 20px; }
        .full-width { grid-column: 1 / -1; }
        h1, h2 { color: #005f6b; text-align: center; }
        .summary-box { text-align: center; }
        .summary-box h3 { margin-top: 0; }
        .summary-box .value { font-size: 2em; font-weight: bold; color: #008793; }
        .summary-box .percent { font-size: 1.5em; font-weight: bold; }
        .percent.positive { color: #28a745; }
        .percent.negative { color: #dc3545; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
</head>
<body>

    <div class="dashboard-grid">
        <div class="card full-width">
            <h1>Sustainability Dashboard</h1>
        </div>

        <div class="card">
            <h2>Live Carbon Intensity</h2>
            <div class="summary-box">
                <h3 id="intensity-level">Loading...</h3>
                <div id="intensity-value" class="value">--</div>
                <div>gCO2/kWh</div>
            </div>
        </div>

        <div class="card">
            <h2>Recent Performance</h2>
            <div class="summary-box">
                <h3>Improvement (last 7 days vs previous)</h3>
                <div id="improvement-percent" class="percent">--%</div>
            </div>
        </div>
        
        <div class="card full-width">
            <h2>Carbon Usage History (gCO2eq per minute)</h2>
            <canvas id="carbonHistoryChart"></canvas>
        </div>

        <div class="card full-width">
            <h2>Best Time to Work (Carbon Intensity Forecast)</h2>
            <canvas id="carbonForecastChart"></canvas>
        </div>
    </div>

    <script>
        let historyChart, forecastChart;

        function updateIntensityGauge(intensity) {
            const valueEl = document.getElementById('intensity-value');
            const levelEl = document.getElementById('intensity-level');
            valueEl.textContent = intensity;
            if (intensity <= 50) { levelEl.textContent = "Very Low"; levelEl.style.color = "#28a745"; } 
            else if (intensity <= 150) { levelEl.textContent = "Low"; levelEl.style.color = "#8fC317"; }
            else if (intensity <= 250) { levelEl.textContent = "Moderate"; levelEl.style.color = "#ffc107"; }
            else if (intensity <= 350) { levelEl.textContent = "High"; levelEl.style.color = "#fd7e14"; }
            else { levelEl.textContent = "Very High"; levelEl.style.color = "#dc3545"; }
        }

        function updatePerformanceSummary(percent) {
            const percentEl = document.getElementById('improvement-percent');
            const sign = percent > 0 ? "+" : "";
            percentEl.textContent = `${sign}${percent.toFixed(1)}%`;
            percentEl.className = "percent " + (percent >= 0 ? "positive" : "negative");
        }

        async function initializeDashboard() {
            const historyCtx = document.getElementById('carbonHistoryChart').getContext('2d');
            historyChart = new Chart(historyCtx, { type: 'line', data: { labels: [], datasets: [{ label: 'gCO2eq', data: [], borderColor: '#005f6b', fill: true }] } });

            const forecastCtx = document.getElementById('carbonForecastChart').getContext('2d');
            forecastChart = new Chart(forecastCtx, { type: 'bar', options: { scales: { x: { type: 'time', time: { unit: 'hour' } } } } });

            updateDashboard();
            updateForecastAndSummary(); 
        }

        async function updateDashboard() {
            const historyResponse = await fetch('/api/v1/all_readings');
            const historyData = await historyResponse.json();
            
            if (historyData.length > 0) {
                const latestReading = historyData[historyData.length - 1];
                updateIntensityGauge(latestReading.carbon_intensity);

                historyChart.data.labels = historyData.map(r => new Date(r.timestamp).toLocaleString());
                historyChart.data.datasets[0].data = historyData.map(r => r.gco2eq);
                historyChart.update();
            }
        }
        
        async function updateForecastAndSummary() {
            const perfResponse = await fetch('/api/v1/performance_summary');
            const perfData = await perfResponse.json();
            updatePerformanceSummary(perfData.improvement_percent);

            const forecastResponse = await fetch('/api/v1/carbon_intensity_forecast');
            const forecastData = await forecastResponse.json();

                if (forecastData.length > 0) {
                    const firstDataPointTime = new Date(forecastData[0].from);


                    firstDataPointTime.setMinutes(0, 0, 0);


                forecastChart.options.scales.x.min = firstDataPointTime;

                forecastChart.data.datasets = [{
                    label: 'Forecasted Intensity (gCO2/kWh)',
                    data: forecastData.map(d => ({ x: new Date(d.from), y: d.intensity.forecast })),
                    backgroundColor: forecastData.map(d => {
                        const intensity = d.intensity.forecast;
                        if (intensity <= 100) return 'rgba(40, 167, 69, 0.7)';
                        if (intensity <= 250) return 'rgba(255, 193, 7, 0.7)';
                        return 'rgba(220, 53, 69, 0.7)';
                    })
                }];
                forecastChart.update();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeDashboard();

            setInterval(updateDashboard, 60000);
        });
    </script>
</body>
</html>