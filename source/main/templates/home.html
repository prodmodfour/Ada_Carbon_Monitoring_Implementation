{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ada</title>
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>
  <!-- Top navigation bar approximating the original header -->
  <header class="top-nav">
    <div class="left">
      <div class="logo-text">Scientific Computing</div>
      <div class="logo-separator"></div>
      <div class="logo-text">Ada Lovelace Centre</div>
    </div>
    <div class="right">
      <!-- Optional right-side items -->
    </div>
  </header>

  <!-- Hero section with large icon and introduction -->
  <section class="home-hero">
    <img src="{% static 'images/atom.png' %}" alt="Atom" class="hero-icon">
    <div class="hero-content">
      <h1 class="hero-title">Ada</h1>
      <p class="hero-description">
        Welcome to Ada (previously known as DAaaS). This service enables remote data access and creation of Workspaces, providing all necessary software, data, and compute resources for your analysis. Ada offers access to the data generated by the ISIS Neutron and Muon Source and the Central Laser Facility (CLF). We also host various training courses, giving course attendees access to Workspaces for practical experience using software for analysis.
      </p>
    </div>
  </section>

  <!-- SCI Score (Home) -->
  <section class="sci-card" data-sci-url="{% url 'sci_score_api' %}">
    <div class="sci-head">
      <div>
        <div class="sci-title">SCI Score</div>
        <div class="sci-caption">Lower is better. Functional unit: compute-hour (kg CO₂e / FU).</div>
      </div>
      <div class="sci-controls">
        <div class="seg">
          <button class="seg-btn active" data-sci-range="day" aria-pressed="true">Day</button>
          <button class="seg-btn" data-sci-range="month" aria-pressed="false">Month</button>
          <button class="seg-btn" data-sci-range="year" aria-pressed="false">Year</button>
        </div>
        <button id="sciHelpBtn" class="sci-help-btn" aria-haspopup="dialog" aria-expanded="false" aria-controls="sciHelp" title="What is SCI?">?</button>
      </div>
    </div>

    <!-- Help popover -->
    <div class="sci-popover hidden" id="sciHelp" role="dialog" aria-modal="true" aria-label="About SCI Score">
      <button class="sci-popover-close" id="sciHelpClose" aria-label="Close">×</button>
      <h4>What is SCI?</h4>
      <p>The Software Carbon Intensity (SCI) score expresses carbon per functional unit (FU). In this mock, FU = one compute-hour.</p>
      <ol class="sci-popover-list">
        <li><strong>Operational</strong> = electricity (kWh) × grid carbon intensity (g/kWh ÷ 1000).</li>
        <li><strong>Embodied</strong> = manufacturing/infra emissions amortized over hardware lifetime (kg ÷ hours).</li>
        <li><strong>SCI</strong> = Operational + Embodied (kg CO₂e / FU).</li>
      </ol>
      <p>You can adjust TDP, embodied values, lifetime, or CI factor in the API later for more accurate scoring.</p>
      <p class="sci-popover-foot">Based on the Green Software Foundation’s SCI approach.</p>
    </div>

    <div class="sci-body">
      <div class="sci-chart" style="position:relative;width:100%;height:240px;">
        <canvas id="sciChart"></canvas>
        <div class="sci-center" id="sciCenter" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:700;color:#37474f;">—</div>
      </div>

      <aside class="sci-metrics">
        <div class="metric-card">
          <div class="metric-title">Breakdown (kg CO₂e / FU)</div>
          <ul class="metric-list">
            <li>Operational: <strong id="sciOp">—</strong></li>
            <li>Embodied: <strong id="sciEmb">—</strong></li>
          </ul>
        </div>
        <div class="metric-card">
          <div class="metric-title">Assumptions</div>
          <ul class="metric-list" id="sciAssump">
            <!-- filled by JS -->
          </ul>
        </div>
      </aside>
    </div>

    <div class="sci-note" id="sciNote"></div>
    <div class="ci-error hidden" id="sciErr" role="alert">
      <span id="sciErrMsg">Unable to load SCI score.</span>
      <button id="sciRetry" class="pill">Retry</button>
    </div>
  </section>

  <!-- Card grid for selecting data sources and features -->
  <div class="card-grid">
    <!-- ISIS card -->
    <a href="{% url 'analysis' 'ISIS' %}" class="card">
      <div class="card-icon-text">
        <span class="card-heading">ISIS Neutron and Muon Source</span>
      </div>
      <div class="card-description">
        Analyse ISIS Experiment Data
      </div>
    </a>
    <!-- CLF card -->
    <a href="{% url 'analysis' 'CLF' %}" class="card">
      <div class="card-icon-text">
        <span class="card-heading">Central Laser Facility</span>
      </div>
      <div class="card-description">
        Analyse CLF Experiment Data
      </div>
    </a>
    <!-- Diamond card with Beta tag -->
    <a href="{% url 'analysis' 'Diamond' %}" class="card">
      <div class="beta-tag">Beta</div>
      <div class="card-icon-text">
        <span class="card-heading">Diamond</span>
      </div>
      <div class="card-description">
        Analyse Diamond Experiment Data
      </div>
    </a>
    <!-- Training card (disabled placeholder) -->
    <div class="card disabled">
      <div class="card-icon-text">
        <span class="card-heading">Training</span>
      </div>
      <div class="card-description">
        Host your own training courses on our platform.
      </div>
    </div>
    <!-- Developer card (disabled placeholder) -->
    <div class="card disabled">
      <div class="card-icon-text">
        <span class="card-heading">Developer</span>
      </div>
      <div class="card-description">
        Use our platform to develop and test software.
      </div>
    </div>
  </div>

  <!-- Chart.js + SCI script -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
  (() => {
    const $  = (s) => document.querySelector(s);
    const $$ = (s) => Array.from(document.querySelectorAll(s));

    const TARGET_BUDGET = 0.20;   // display target (kg CO2e / FU)
    let sciChart;
    let currentRange = 'day';

    const ctx  = document.getElementById('sciChart').getContext('2d');
    const ctr  = document.getElementById('sciCenter');
    const elOp = document.getElementById('sciOp');
    const elEm = document.getElementById('sciEmb');
    const elAss= document.getElementById('sciAssump');
    const elNote = document.getElementById('sciNote');
    const elErr  = document.getElementById('sciErr');
    const elErrMsg = document.getElementById('sciErrMsg');

    // Read resolved API URL from DOM (robust to any URL prefix)
    const sciApiBase = document.querySelector('.sci-card').dataset.sciUrl;

    function setCenter(text){ ctr.textContent = text; }

    function renderRing(score, target){
      const filled = Math.min(score/target, 1);
      const data = { labels: ['Score','Remaining'], datasets: [{ data: [filled, 1-filled], cutout: '70%' }] };
      const options = { responsive:true, maintainAspectRatio:false, resizeDelay:150, plugins:{ legend:{display:false}, tooltip:{enabled:false} } };
      if (sciChart) { sciChart.data = data; sciChart.options = options; sciChart.update(); }
      else { sciChart = new Chart(ctx, { type:'doughnut', data, options }); }
    }

    function renderAssumptions(a){
      elAss.innerHTML = `
        <li>CI: ${a.ci_g_per_kwh} g/kWh</li>
        <li>Lifetime: ${a.lifetime_h.toLocaleString()} h</li>
        <li>TDP: CPU ${a.tdp_spec.cpu_count}×${a.tdp_spec.cpu_tdp_w}W, GPU ${a.tdp_spec.gpu_count}×${a.tdp_spec.gpu_tdp_w}W</li>
        <li>Other: RAM ${a.tdp_spec.ram_w}W, Misc ${a.tdp_spec.other_w}W</li>
      `;
    }

    async function fetchSCI(range){
      const url = `${sciApiBase}?range=${encodeURIComponent(range)}`;
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) {
        const text = await res.text().catch(()=> '');
        throw new Error(`HTTP ${res.status}${text ? `: ${text.slice(0,120)}` : ''}`);
      }
      return res.json();
    }

    async function loadSCI(range = currentRange){
      try{
        elErr.classList.add('hidden');
        const data = await fetchSCI(range);

        const avg = data.avg_score;
        setCenter(`${avg.toFixed(2)} kg/FU`);
        renderRing(avg, TARGET_BUDGET);

        elOp.textContent = data.operational_kg_per_fu.toFixed(3);
        elEm.textContent = data.embodied_kg_per_fu.toFixed(3);
        renderAssumptions(data.assumptions);

        elNote.textContent = `Average across ${data.labels.length} bins · Target ${TARGET_BUDGET} kg CO₂e/FU`;
      }catch(err){
        console.error('SCI fetch failed:', err);
        elErrMsg.textContent = `Unable to load SCI score (${err.message}).`;
        elErr.classList.remove('hidden');
      }
    }

    // Range controls
    document.querySelector('.sci-controls').addEventListener('click', (e) => {
      const btn = e.target.closest('[data-sci-range]'); if (!btn) return;
      $$('.sci-controls .seg-btn').forEach(b => { b.classList.remove('active'); b.setAttribute('aria-pressed','false'); });
      btn.classList.add('active'); btn.setAttribute('aria-pressed','true');
      currentRange = btn.dataset.sciRange;
      loadSCI();
    });
    document.getElementById('sciRetry').addEventListener('click', () => loadSCI());

    // Help popover
    const elHelpBtn = document.getElementById('sciHelpBtn');
    const elHelp    = document.getElementById('sciHelp');
    const elClose   = document.getElementById('sciHelpClose');
    let open = false, onDoc=null, onEsc=null;

    function openHelp(){
      if (open) return;
      elHelp.classList.remove('hidden');
      elHelpBtn.setAttribute('aria-expanded','true');
      open = true;
      onDoc = (e)=>{ if (!elHelp.contains(e.target) && e.target !== elHelpBtn) closeHelp(); };
      onEsc = (e)=>{ if (e.key === 'Escape') closeHelp(); };
      document.addEventListener('mousedown', onDoc);
      document.addEventListener('keydown', onEsc);
    }
    function closeHelp(){
      if (!open) return;
      elHelp.classList.add('hidden');
      elHelpBtn.setAttribute('aria-expanded','false');
      open = false;
      document.removeEventListener('mousedown', onDoc);
      document.removeEventListener('keydown', onEsc);
    }
    elHelpBtn.addEventListener('click', ()=> open ? closeHelp() : openHelp());
    elClose.addEventListener('click', closeHelp);

    // Initial load
    loadSCI();
  })();
  </script>
</body>
</html>
