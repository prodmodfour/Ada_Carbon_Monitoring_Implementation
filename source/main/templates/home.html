{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ada</title>
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>
  <!-- Top navigation bar approximating the original header -->
  <header class="top-nav">
    <div class="left">
      <div class="logo-text">Scientific Computing</div>
      <div class="logo-separator"></div>
      <div class="logo-text">Ada Lovelace Centre</div>
    </div>
    <div class="right">
      <!-- Optional right-side items -->
    </div>
  </header>

  <!-- Hero section with large icon and introduction -->
  <section class="home-hero">
    <img src="{% static 'images/atom.png' %}" alt="Atom" class="hero-icon">
    <div class="hero-content">
      <h1 class="hero-title">Ada</h1>
      <p class="hero-description">
        Welcome to Ada (previously known as DAaaS). This service enables remote data access and creation of Workspaces, providing all necessary software, data, and compute resources for your analysis. Ada offers access to the data generated by the ISIS Neutron and Muon Source and the Central Laser Facility (CLF). We also host various training courses, giving course attendees access to Workspaces for practical experience using software for analysis.
      </p>
    </div>
  </section>

 <!-- Metrics row: GHG (left) + SCI (right) -->
<div class="home-metrics">

  <!-- GHG Score (left) -->
  <section class="ghg-card clean" data-ghg-url="{% url 'ghg_score_api' %}">
    <div class="sci-head">
      <div>
        <div class="sci-title">GHG Score</div>
        <div class="sci-caption">lower is better</div>
      </div>
      <button id="ghgHelpBtn" class="sci-help-btn"
              aria-haspopup="dialog" aria-expanded="false"
              aria-controls="ghgHelp" title="What is GHG Score?">?</button>
    </div>

    <!-- Help popover -->
    <div class="sci-popover hidden" id="ghgHelp" role="dialog" aria-modal="true" aria-label="About GHG Score">
      <button class="sci-popover-close" id="ghgHelpClose" aria-label="Close">×</button>
      <h4>What is GHG Score?</h4>
      <p>A simple headline greenhouse gas figure for this service—kept minimal here for presentation. It represents an aggregated estimate of emissions for a recent period.</p>

    </div>

    <div class="sci-body solo">
      <div class="sci-value-wrap">
        <div id="ghgValue" class="sci-value">—</div>
      </div>
    </div>
  </section>

  <!-- SCI Score (right) – unchanged minimal style -->
  <section class="sci-card clean" data-sci-url="{% url 'sci_score_api' %}">
    <div class="sci-head">
      <div>
        <div class="sci-title">SCI Score</div>
        <div class="sci-caption">lower is better</div>
      </div>
      <button id="sciHelpBtn" class="sci-help-btn"
              aria-haspopup="dialog" aria-expanded="false"
              aria-controls="sciHelp" title="What is SCI?">?</button>
    </div>

    <div class="sci-popover hidden" id="sciHelp" role="dialog" aria-modal="true" aria-label="About SCI Score">
      <button class="sci-popover-close" id="sciHelpClose" aria-label="Close">×</button>
      <h4>What is SCI?</h4>
      <p>SCI is carbon per functional unit (FU). Here FU = one compute-hour.</p>
      <ol class="sci-popover-list">
        <li><strong>Operational</strong> = electricity (kWh) × grid CI (g/kWh ÷ 1000).</li>
        <li><strong>Embodied</strong> = amortized manufacturing/infra emissions.</li>
        <li><strong>SCI</strong> = Operational + Embodied.</li>
      </ol>
    </div>

    <div class="sci-body solo">
      <div class="sci-value-wrap">
        <div id="sciValue" class="sci-value">—</div>
      </div>
    </div>
  </section>

</div>

  
  
  

  <!-- Card grid for selecting data sources and features -->
  <div class="card-grid">
    <!-- ISIS card -->
    <a href="{% url 'analysis' 'ISIS' %}" class="card">
      <div class="card-icon-text">
        <span class="card-heading">ISIS Neutron and Muon Source</span>
      </div>
      <div class="card-description">
        Analyse ISIS Experiment Data
      </div>
    </a>
    <!-- CLF card -->
    <a href="{% url 'analysis' 'CLF' %}" class="card">
      <div class="card-icon-text">
        <span class="card-heading">Central Laser Facility</span>
      </div>
      <div class="card-description">
        Analyse CLF Experiment Data
      </div>
    </a>
    <!-- Diamond card with Beta tag -->
    <a href="{% url 'analysis' 'Diamond' %}" class="card">
      <div class="beta-tag">Beta</div>
      <div class="card-icon-text">
        <span class="card-heading">Diamond</span>
      </div>
      <div class="card-description">
        Analyse Diamond Experiment Data
      </div>
    </a>
    <!-- Training card (disabled placeholder) -->
    <div class="card disabled">
      <div class="card-icon-text">
        <span class="card-heading">Training</span>
      </div>
      <div class="card-description">
        Host your own training courses on our platform.
      </div>
    </div>
    <!-- Developer card (disabled placeholder) -->
    <div class="card disabled">
      <div class="card-icon-text">
        <span class="card-heading">Developer</span>
      </div>
      <div class="card-description">
        Use our platform to develop and test software.
      </div>
    </div>
  </div>

  <!-- SCI script -->
  <script>
    (() => {
      const sciCard = document.querySelector('.sci-card.clean');
      const sciApi  = sciCard.dataset.sciUrl;
      const elValue = document.getElementById('sciValue');
    
      function setNumber(x){
        // trigger tiny pop-in animation on update
        elValue.classList.remove('popin');
        // force reflow to restart animation
        void elValue.offsetWidth;
        elValue.textContent = Number(x).toFixed(2);
        elValue.classList.add('popin');
      }
    
      async function loadSCI(){
        try{
          const res = await fetch(`${sciApi}?range=day`, { cache: 'no-store' });
          if(!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          setNumber(data.avg_score);
        }catch(err){
          console.error('SCI fetch failed:', err);
          elValue.textContent = '—';
        }
      }
    
      // ? popover
      const btn = document.getElementById('sciHelpBtn');
      const pop = document.getElementById('sciHelp');
      const x   = document.getElementById('sciHelpClose');
      let open=false, onDoc=null, onEsc=null;
      function openHelp(){ if(open) return; pop.classList.remove('hidden'); btn.setAttribute('aria-expanded','true'); open=true;
        onDoc=(e)=>{ if(!pop.contains(e.target)&&e.target!==btn) closeHelp(); };
        onEsc=(e)=>{ if(e.key==='Escape') closeHelp(); };
        document.addEventListener('mousedown', onDoc); document.addEventListener('keydown', onEsc);
      }
      function closeHelp(){ if(!open) return; pop.classList.add('hidden'); btn.setAttribute('aria-expanded','false'); open=false;
        document.removeEventListener('mousedown', onDoc); document.removeEventListener('keydown', onEsc);
      }
      btn.addEventListener('click', ()=> open ? closeHelp() : openHelp());
      x.addEventListener('click', closeHelp);
    
      loadSCI();
    })();
    </script>

<script>
  /* ---------- GHG Score (number + help) ---------- */
  (() => {
    const card = document.querySelector('.ghg-card.clean');
    const api  = card.dataset.ghgUrl;
    const val  = document.getElementById('ghgValue');
  
    function popIn(el, text){
      el.classList.remove('popin'); void el.offsetWidth;
      el.textContent = text; el.classList.add('popin');
    }
  
    async function loadGHG(){
      try{
        // keep backend free to change; accept value|avg_score|score
        const res = await fetch(`${api}?range=day`, { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const v = data.value ?? data.avg_score ?? data.score ?? null;
        popIn(val, v != null ? Number(v).toFixed(2) : '—');
      }catch(e){
        console.error('GHG fetch failed:', e);
        val.textContent = '—';
      }
    }
  
    // Help popover
    const btn = document.getElementById('ghgHelpBtn');
    const pop = document.getElementById('ghgHelp');
    const x   = document.getElementById('ghgHelpClose');
    let open=false, onDoc=null, onEsc=null;
    function openHelp(){ if(open) return; pop.classList.remove('hidden'); btn.setAttribute('aria-expanded','true'); open=true;
      onDoc=(e)=>{ if(!pop.contains(e.target)&&e.target!==btn) closeHelp(); };
      onEsc=(e)=>{ if(e.key==='Escape') closeHelp(); };
      document.addEventListener('mousedown', onDoc); document.addEventListener('keydown', onEsc);
    }
    function closeHelp(){ if(!open) return; pop.classList.add('hidden'); btn.setAttribute('aria-expanded','false'); open=false;
      document.removeEventListener('mousedown', onDoc); document.removeEventListener('keydown', onEsc);
    }
    btn.addEventListener('click', ()=> open ? closeHelp() : openHelp());
    x.addEventListener('click', closeHelp);
  
    loadGHG();
  })();
  </script>
  
  <script>
  /* ---------- SCI Score (number + help) – minimal ---------- */
  (() => {
    const sciCard = document.querySelector('.sci-card.clean');
    const sciApi  = sciCard.dataset.sciUrl;
    const elValue = document.getElementById('sciValue');
  
    function setNumber(x){
      elValue.classList.remove('popin'); void elValue.offsetWidth;
      elValue.textContent = Number(x).toFixed(2);
      elValue.classList.add('popin');
    }
  
    async function loadSCI(){
      try{
        const res = await fetch(`${sciApi}?range=day`, { cache: 'no-store' });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        setNumber(data.avg_score);
      }catch(err){
        console.error('SCI fetch failed:', err);
        elValue.textContent = '—';
      }
    }
  
    const btn = document.getElementById('sciHelpBtn');
    const pop = document.getElementById('sciHelp');
    const x   = document.getElementById('sciHelpClose');
    let open=false, onDoc=null, onEsc=null;
    function openHelp(){ if(open) return; pop.classList.remove('hidden'); btn.setAttribute('aria-expanded','true'); open=true;
      onDoc=(e)=>{ if(!pop.contains(e.target)&&e.target!==btn) closeHelp(); };
      onEsc=(e)=>{ if(e.key==='Escape') closeHelp(); };
      document.addEventListener('mousedown', onDoc); document.addEventListener('keydown', onEsc);
    }
    function closeHelp(){ if(!open) return; pop.classList.add('hidden'); btn.setAttribute('aria-expanded','false'); open=false;
      document.removeEventListener('mousedown', onDoc); document.removeEventListener('keydown', onEsc);
    }
    btn.addEventListener('click', ()=> open ? closeHelp() : openHelp());
    x.addEventListener('click', closeHelp);
  
    loadSCI();
  })();
  </script>
  
  

</body>
</html>
