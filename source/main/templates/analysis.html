{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{ source_title }}</title>
  <link rel="stylesheet" href="{% static 'css/style.css' %}" />
</head>
<body>
  <!-- Top navigation bar with dynamic title -->
  <header class="top-nav">
    <div class="left">
      <img src="{% static 'images/small_atom.png' %}" alt="Atom" class="small-icon" />
      <span class="analysis-title">{{ source_title }}</span>
    </div>
    <div class="right">
      <span class="logout-link">Logout</span>
    </div>
  </header>

  <div class="page-body">
    <!-- Sidebar -->
    <nav class="sidebar">
      <ul>
        <li><img src="{% static 'images/icon_workspaces.png' %}" alt="" />Workspaces</li>
        <li><img src="{% static 'images/icon_data.png' %}" alt="" />Data</li>
        <li><img src="{% static 'images/icon_experiments.png' %}" alt="" />Experiments</li>
        <li><img src="{% static 'images/icon_question.png' %}" alt="" />Help</li>
        <li><img src="{% static 'images/icon_info.png' %}" alt="" />About</li>
      </ul>
    </nav>

    <!-- Main content -->
    <main class="content">

      <!-- Hero card: New Workspace -->
      <div class="analysis-card" style="margin-bottom: 18px;">
        <div class="analysis-card-left">
          <img src="{% static 'images/icon_new_workspace.png' %}" alt="" class="analysis-card-icon" />
          <div>
            <div class="analysis-card-title">New Workspace</div>
            <div class="analysis-card-subtitle">
              Workspaces provide you with software and compute resources to analyse your experiment data
            </div>
          </div>
        </div>
        <div class="analysis-card-right">
          <!-- Clicking the arrow navigates to the instrument selection page for the current source -->
          <a href="{% url 'instruments' source=source %}">
            <img src="{% static 'images/icon_arrow.png' %}" alt="Go" />
          </a>
        </div>
      </div>

      <!-- Carbon Intensity Forecast (GB) -->
      <section class="ci-card">
        <div class="ci-header">
          <div>
            <div class="ci-title">Carbon Intensity Forecast (GB)</div>
            <div class="ci-caption">
              All times local. <span>Source: GB Carbon Intensity API.</span>
              <span id="ciRefreshed" aria-live="polite"></span>
            </div>
          </div>

          <div class="ci-controls">
            <button class="pill active" data-range="working" aria-pressed="true" title="08:00–17:00">
              Working day (8:00–17:00)
            </button>
            <button class="pill" data-range="24h" aria-pressed="false">Next 24 hours</button>
            <button class="pill" data-range="48h" aria-pressed="false">Next 48 hours</button>
            <button class="pill" data-range="custom" aria-pressed="false">Custom</button>

            <div id="ciCustom" class="ci-custom hidden" aria-hidden="true">
              <label>
                From
                <input type="datetime-local" id="ciFrom">
              </label>
              <label>
                To
                <input type="datetime-local" id="ciTo">
              </label>
              <button id="ciApply" class="pill">Apply</button>
            </div>
          </div>
          <button id="ciHelpBtn" class="ci-help-btn" aria-haspopup="dialog" aria-expanded="false" aria-controls="ciHelp" title="What is this?">?</button>
        </div>

        <div class="ci-popover hidden" id="ciHelp" role="dialog" aria-modal="true" aria-label="About Carbon Intensity Forecast (GB)">
          <button class="ci-popover-close" id="ciHelpClose" aria-label="Close">×</button>
          <h4>What am I seeing?</h4>
          <ul class="ci-popover-list">
            <li><strong>Data:</strong> half-hourly <em>forecast</em> of GB grid carbon intensity (gCO₂/kWh).</li>
            <li><strong>Times:</strong> shown in your local time; the API provides UTC which we convert.</li>
            <li><strong>Ranges:</strong> Working day (08:00–17:00), next 24h, next 48h, or a custom range
              (capped at 48h since longer forecasts are less accurate).</li>
            <li><strong>Best 3-hour window:</strong> the light green band marks the lowest contiguous 3 hours
              (6 half-hour points) by average gCO₂/kWh.</li>
            <li><strong>Now marker:</strong> a dashed line appears if “now” falls in the selected range.</li>
            <li><strong>Working day rule:</strong> before 08:00 → today; after 17:00 → tomorrow (weekends included).</li>
          </ul>
          <p class="ci-popover-foot">Source: GB Carbon Intensity API.</p>
        </div>

        <div class="ci-chart">
          <canvas id="ciForecastChart"></canvas>
        </div>

        <div class="ci-note" id="ciNote" role="note"></div>
        <div class="ci-error hidden" id="ciError" role="alert">
          <span id="ciErrorMsg">Unable to load forecast.</span>
          <button id="ciRetry" class="pill">Retry</button>
        </div>
      </section>

      <!-- Estimated Electricity / Carbon Usage (HTMX + Plotly) -->
      <section class="usage-card">
        <div class="usage-head">
          <div>
            <div class="usage-title">Estimated Usage (Project)</div>
          </div>

          <div class="usage-controls" id="usageControls"
               data-url-template="{% url 'get_usage_plot' source 'RANGE' 'VIEW' %}">
            <div class="seg" role="tablist" aria-label="Metric">
              <button class="seg-btn active" data-view="electricity" aria-selected="true" role="tab">Electricity</button>
              <button class="seg-btn" data-view="carbon" aria-selected="false" role="tab">Carbon</button>
            </div>
            <div class="seg" role="group" aria-label="Range">
              <button class="seg-btn active" data-range="day" aria-pressed="true">Day</button>
              <button class="seg-btn" data-range="month" aria-pressed="false">Month</button>
              <button class="seg-btn" data-range="year" aria-pressed="false">Year</button>
            </div>
            <button id="usageHelpBtn" class="usage-help-btn"
              aria-haspopup="dialog" aria-expanded="false"
              aria-controls="usageHelp" title="What is this?">?</button>
          </div>
        </div>

        <div class="usage-popover hidden" id="usageHelp" role="dialog"
             aria-modal="true" aria-label="About Estimated Usage (Project)">
          <button class="usage-popover-close" id="usageHelpClose" aria-label="Close">×</button>

          <h4>How the estimate is built</h4>
          <ol class="usage-popover-list">
            <li><strong>Electricity:</strong> sums estimated watt-hours per bin and converts to kWh.</li>
            <li><strong>Carbon:</strong> multiplies kWh by grid intensity to get kg CO₂e.</li>
            <li>Data shown uses your project’s parquet series, resampled by hour/day/month.</li>
          </ol>
        </div>

        <div class="usage-body">
          <div id="usagePlot" class="usage-chart" style="position:relative; height: 320px; max-width: 100%; overflow: hidden;">
            {{ usage_plot_div|safe }}
          </div>
          <aside class="usage-metrics">
            <div class="metric-card">
              <div class="metric-title" id="summaryTitle">Electricity summary</div>
          
              <div class="metric-subtitle">Totals</div>
              <ul class="metric-list">
                <li><strong id="sumTotal">–</strong> <span id="sumUnit">kWh</span> total</li>
                <li>Average per bin: <strong id="sumAvgPerBin">–</strong></li>
                <li>Bins shown: <strong id="sumBins">–</strong></li>
              </ul>
          
              <div class="metric-subtitle" style="margin-top:.5rem;">Distribution</div>
              <ul class="metric-list">
                <li>Peak bin: <strong id="sumPeakVal">–</strong> at <span id="sumPeakLabel">–</span></li>
                <li>Lowest bin: <strong id="sumMinVal">–</strong> at <span id="sumMinLabel">–</span></li>
              </ul>
          
              <div class="metric-subtitle" style="margin-top:.5rem;">Equivalencies</div>
          
              <!-- Electricity equivalencies -->
              <ul class="metric-list" id="eqElectricity">
                <li id="eqElecTotal"><strong>–</strong> total</li>
                <li id="bulbHours">≈ – light-bulb hours (60W)</li>
                <li id="laptopHours">≈ – laptop hours (65W)</li>
                <li id="kettleBoils">≈ – kettle boils (0.11 kWh/boil)</li>
              </ul>
          
              <!-- Carbon equivalencies -->
              <ul class="metric-list" id="eqCarbon" style="display:none;">
                <li><strong id="carbonTotalKg">–</strong> total (kg CO₂e)</li>
                <li id="treeYears">≈ – tree-years</li>
                <li id="carKm">≈ – car km</li>
                <li id="flightPct">≈ – of a Paris→Dubai flight</li>
              </ul>
          
            </div>
          </aside>
        </div>

        <div class="ci-error hidden" id="usageErr" role="alert">
          <span id="usageErrMsg">Unable to load usage.</span>
          <button id="usageRetry" class="pill">Retry</button>
        </div>
      </section>

      <!-- Workspace list -->
      {% if workspaces %}
        <h2 class="workspaces-heading">Your Workspaces</h2>
        <div class="workspace-list">
          {% for ws in workspaces %}
            <div class="workspace-card">
              <div class="workspace-card-top">
                <div class="workspace-card-title">
                  <img src="{% static 'images/icon_new_workspace.png' %}" alt="" class="analysis-card-icon" />
                  <span>{{ ws.title }}</span>
                </div>
                <!-- Gear MUST be inside .workspace-card-top -->
                <a class="workspace-card-gear" title="Workspace details"
                   href="{% url 'workspace_detail' source ws.id %}">⚙</a>
              </div>

              <div class="workspace-owner">Ashraf Hussain</div>

              <div class="workspace-previews">
                <div class="preview-box">
                  <div class="preview-label">Desktop</div>
                </div>
                <div class="preview-box">
                  <div class="preview-toolbar">
                    <select class="kernel-select" disabled>
                      <option>Jupyter</option>
                    </select>
                  </div>
                  <div class="preview-label">Jupyter</div>
                </div>
              </div>

              <!-- Workspace Figures (Electricity & Carbon) -->
              <div class="ws-figures"
                   data-total-kwh="{{ ws.total_kwh|default:0 }}"
                   data-idle-kwh="{{ ws.idle_kwh|default:0 }}"
                   data-total-kg="{{ ws.total_kg|default:0 }}"
                   data-idle-kg="{{ ws.idle_kg|default:0 }}"
                   data-idle-w="{{ ws.idle_w|default:0 }}"
                   data-ci="{{ ws.ci|default:220 }}">
                <div class="figure-row">
                  <div class="figure-label">Electricity (kWh)</div>
                  <div class="figure-bar" data-kind="kwh" role="img"
                       aria-label="Idle {{ ws.idle_kwh|default:0 }} of {{ ws.total_kwh|default:0 }} kWh"></div>
                  <div class="figure-legend">
                    <span>Total: {{ ws.total_kwh|default:0 }}</span>
                    <span>Idle: {{ ws.idle_kwh|default:0 }}</span>
                  </div>
                </div>

                <div class="figure-row">
                  <div class="figure-label">Carbon (kg&nbsp;CO₂e)</div>
                  <div class="figure-bar" data-kind="kg" role="img"
                       aria-label="Idle {{ ws.idle_kg|default:0 }} of {{ ws.total_kg|default:0 }} kg CO₂e"></div>
                  <div class="figure-legend">
                    <span>Total: {{ ws.total_kg|default:0 }}</span>
                    <span>Idle: {{ ws.idle_kg|default:0 }}</span>
                  </div>
                </div>

                <div class="idle-live">
                  <span class="idle-dot" aria-hidden="true"></span>
                  <strong>Idle use counter:</strong>
                  <span class="idle-kwh-counter">0.000</span> kWh ·
                  <span class="idle-kg-counter">0.0000</span> kg CO₂e
                </div>
              </div>

              <div class="workspace-actions">
                <button class="start-btn" disabled>START JUPYTER</button>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="no-workspaces-message">
          You don't seem to have any workspaces, create a new workspace to get started.
        </p>
      {% endif %}

    </main>
  </div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>          <!-- for CI chart -->
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>             <!-- for usage chart swapping -->

  <!-- Carbon Intensity Forecast script (unchanged) -->
  <script>
(() => {
  // ===== Utilities =====
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));

  function toIsoUTCMinute(d) {
    const pad = (n) => String(n).padStart(2, '0');
    return d.getUTCFullYear() + '-' + pad(d.getUTCMonth()+1) + '-' + pad(d.getUTCDate())
      + 'T' + pad(d.getUTCHours()) + ':' + pad(d.getUTCMinutes()) + 'Z';
  }
  function nextHalfHour(dt) {
    const d = new Date(dt);
    const m = d.getMinutes();
    if (m === 0 || m === 30) return d;
    d.setMinutes(m < 30 ? 30 : 0);
    if (m > 30) d.setHours(d.getHours() + 1);
    d.setSeconds(0, 0);
    return d;
  }
  function workingDayWindow(nowLocal) {
    const base = new Date(nowLocal);
    const h = base.getHours();
    const day = new Date(base);
    if (h >= 17) day.setDate(day.getDate() + 1);
    const from = new Date(day); from.setHours(8,0,0,0);
    const to   = new Date(day); to.setHours(17,0,0,0);
    return { from, to };
  }
  function cap48(from, to) {
    const maxMs = 48 * 60 * 60 * 1000;
    let capped = false;
    if ((to - from) > maxMs) { to = new Date(from.getTime() + maxMs); capped = true; }
    return { from, to, capped };
  }
  function buildUrl(from, to) {
    const f = toIsoUTCMinute(new Date(from));
    const t = toIsoUTCMinute(new Date(to));
    return `/api/ci?from=${encodeURIComponent(f)}&to=${encodeURIComponent(t)}`
  }
  function best3hWindow(points) {
    if (!points || points.length < 6) return null;
    let best = { i: 0, avg: Infinity };
    let sum = 0;
    for (let i = 0; i < 6; i++) sum += points[i];
    best = { i: 0, avg: sum / 6 };
    for (let i = 6; i < points.length; i++) {
      sum += points[i] - points[i - 6];
      const avg = sum / 6;
      if (avg < best.avg) best = { i: i - 5, avg };
    }
    return best;
  }

  // ===== DOM refs =====
  const elChart = $('#ciForecastChart');
  const elNote = $('#ciNote');
  const elError = $('#ciError');
  const elErrMsg = $('#ciErrorMsg');
  const elRetry = $('#ciRetry');
  const elRefreshed = $('#ciRefreshed');
  const elCustomWrap = $('#ciCustom');
  const elFrom = $('#ciFrom');
  const elTo = $('#ciTo');
  const elControls = document.querySelector('.ci-controls');
  const elHelpBtn   = document.getElementById('ciHelpBtn');
  const elHelp      = document.getElementById('ciHelp');
  const elHelpClose = document.getElementById('ciHelpClose');
  let helpOpen = false;
  let helpOutsideListener = null;
  let helpEscListener = null;

  // Guard: must have canvas + Chart.js
  if (!elChart || typeof Chart === 'undefined') {
    if (elError && elErrMsg) {
      elErrMsg.textContent = 'Chart library not available.';
      elError.classList.remove('hidden');
    }
    return;
  }

  // ===== Chart state =====
  let chart;
  const state = {
    labels: [],
    values: [],
    from: null,
    to: null,
    band: null,
    nowIndex: null,
  };

  const ciHighlightPlugin = {
    id: 'ciHighlight',
    afterDatasetsDraw(c) {
      const { ctx, chartArea: {left, right, top, bottom}, scales: {x} } = c;

      if (state.band && state.values.length > 1) {
        const [i0, i1] = state.band;
        const x0 = x.getPixelForValue(i0);
        const x1 = x.getPixelForValue(i1);
        const tick = Math.abs(x.getPixelForValue(1) - x.getPixelForValue(0)) || 10;
        ctx.save();
        ctx.fillStyle = 'rgba(76, 175, 80, 0.12)';
        ctx.fillRect(x0 - tick/2, top, (x1 - x0) + tick, bottom - top);
        ctx.restore();
      }

      if (state.nowIndex != null) {
        const xNow = x.getPixelForValue(state.nowIndex);
        ctx.save();
        ctx.strokeStyle = 'rgba(0,0,0,0.25)';
        ctx.lineWidth = 1;
        ctx.setLineDash([4,3]);
        ctx.beginPath();
        ctx.moveTo(xNow, top);
        ctx.lineTo(xNow, bottom);
        ctx.stroke();
        ctx.restore();
      }
    }
  };

  function renderChart() {
    const data = {
      labels: state.labels,
      datasets: [{
        label: 'Forecast (gCO₂/kWh)',
        data: state.values,
        borderWidth: 2,
        tension: 0.2,
        fill: false,
      }]
    };
    const options = {
      responsive: true,
      maintainAspectRatio: false,
      resizeDelay: 150,
      plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
      scales: {
        x: { type: 'category', grid: { display: false } },
        y: { grid: { color: '#eee' }, ticks: { callback: (v) => v + '' } }
      }
    };

    if (chart) {
      chart.data = data;
      chart.update();
    } else {
      chart = new Chart(elChart.getContext('2d'), {
        type: 'line',
        data,
        options,
        plugins: [ciHighlightPlugin]
      });
    }
  }

  function setNote(from, to, capped, best, labels) {
    const parts = [];
    if (best) {
      const start = labels[best.i];
      const end = labels[Math.min(best.i + 5, labels.length - 1)];
      parts.push(`Best 3h window: ${start}–${end} (avg ${Math.round(best.avg)} gCO₂/kWh)`);
    }
    if (capped) {
      parts.push(`Note: Range capped to 48 hours; forecasting beyond 48h is less accurate.`);
    }
    if (elNote) elNote.textContent = parts.join(' · ');
  }

  function buildLabels(items) {
    const labels = [];
    const now = new Date();
    state.nowIndex = null;

    items.forEach((it, idx) => {
      const start = new Date(it.from);
      const hh = String(start.getHours()).padStart(2,'0');
      const mm = String(start.getMinutes()).padStart(2,'0');
      labels.push(`${hh}:${mm}`);

      if (start <= now && new Date(it.to) > now) state.nowIndex = idx;
    });
    return labels;
  }

  async function loadRange(fromLocal, toLocal, { clamp48 = true } = {}) {
    const max = clamp48 ? cap48(fromLocal, toLocal) : { from: fromLocal, to: toLocal, capped: false };
    const url = buildUrl(max.from, max.to);

    if (elError) elError.classList.add('hidden');
    if (elNote) elNote.textContent = 'Loading forecast…';

    try {
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const json = await res.json();

      const items = (json && json.data) ? json.data : [];
      const values = items.map(d => d.intensity && (d.intensity.forecast ?? d.intensity.actual ?? null)).filter(v => v != null);

      state.labels = buildLabels(items);
      state.values = values;
      state.from = max.from;
      state.to = max.to;

      const best = best3hWindow(values);
      state.band = best ? [best.i, best.i + 5] : null;

      renderChart();
      setNote(max.from, max.to, max.capped, best, state.labels);
      if (elRefreshed) elRefreshed.textContent = `· refreshed ${new Date().toLocaleTimeString()}`;
    } catch (err) {
      if (elErrMsg) elErrMsg.textContent = `Unable to load forecast (${err.message}).`;
      if (elError) elError.classList.remove('hidden');
      if (elNote) elNote.textContent = '';
    }
  }

  function setActive(btn) {
    if (!btn) return;
    const group = btn.closest('.ci-controls') || btn.parentElement;
    if (!group) return;
    const pills = Array.from(group.querySelectorAll('.pill'));
    pills.forEach(b => { b.classList.remove('active'); b.setAttribute('aria-pressed','false'); });
    btn.classList.add('active');
    btn.setAttribute('aria-pressed','true');
  }
  function initCustomInputs(defaultFrom, defaultTo) {
    if (!elFrom || !elTo) return;
    const toLocalInput = (d) => {
      const pad = (n) => String(n).padStart(2,'0');
      const dt = new Date(d);
      return dt.getFullYear() + '-' + pad(dt.getMonth()+1) + '-' + pad(dt.getDate()) + 'T' + pad(dt.getHours()) + ':' + pad(dt.getMinutes());
    };
    elFrom.value = toLocalInput(defaultFrom);
    elTo.value = toLocalInput(defaultTo);
  }

  function selectWorkingDay() {
    const { from, to } = workingDayWindow(new Date());
    const btn = document.querySelector('[data-range="working"]');
    setActive(btn);
    if (elCustomWrap) { elCustomWrap.classList.add('hidden'); elCustomWrap.setAttribute('aria-hidden','true'); }
    loadRange(from, to, { clamp48: true });
  }
  function select24h() {
    const start = nextHalfHour(new Date());
    const end = new Date(start.getTime() + 24*60*60*1000);
    const btn = document.querySelector('[data-range="24h"]');
    setActive(btn);
    if (elCustomWrap) { elCustomWrap.classList.add('hidden'); elCustomWrap.setAttribute('aria-hidden','true'); }
    loadRange(start, end, { clamp48: true });
  }
  function select48h() {
    const start = nextHalfHour(new Date());
    const end = new Date(start.getTime() + 48*60*60*1000);
    const btn = document.querySelector('[data-range="48h"]');
    setActive(btn);
    if (elCustomWrap) { elCustomWrap.classList.add('hidden'); elCustomWrap.setAttribute('aria-hidden','true'); }
    loadRange(start, end, { clamp48: true });
  }
  function selectCustom() {
    const start = nextHalfHour(new Date());
    const end = new Date(start.getTime() + 6*60*60*1000);
    const btn = document.querySelector('[data-range="custom"]');
    setActive(btn);
    if (elCustomWrap) { elCustomWrap.classList.remove('hidden'); elCustomWrap.setAttribute('aria-hidden','false'); }
    initCustomInputs(start, end);
  }

  if (elControls) {
    elControls.addEventListener('click', (e) => {
      const btn = e.target.closest('.pill');
      if (!btn) return;
      const r = btn.dataset.range;
      if (r === 'working') return selectWorkingDay();
      if (r === '24h')     return select24h();
      if (r === '48h')     return select48h();
      if (r === 'custom')  return selectCustom();
    });
  }

  const btnApply = $('#ciApply');
  if (btnApply) {
    btnApply.addEventListener('click', () => {
      if (!elFrom || !elTo) return;
      const from = new Date(elFrom.value);
      const to = new Date(elTo.value);
      if (isNaN(from.getTime()) || isNaN(to.getTime()) || to <= from) {
        if (elErrMsg) elErrMsg.textContent = 'Please provide a valid custom range (To must be after From).';
        if (elError) elError.classList.remove('hidden');
        return;
      }
      loadRange(from, to, { clamp48: true });
    });
  }

  const btnRetry = $('#ciRetry');
  if (btnRetry) {
    btnRetry.addEventListener('click', () => {
      const active = document.querySelector('.ci-controls .pill.active');
      if (!active) return selectWorkingDay();
      const r = active.dataset.range;
      if (r === 'working') return selectWorkingDay();
      if (r === '24h')     return select24h();
      if (r === '48h')     return select48h();
      if (r === 'custom')  return (btnApply && btnApply.click());
    });
  }

  function openHelp(){
    if (helpOpen || !elHelp || !elHelpBtn) return;
    elHelp.classList.remove('hidden');
    elHelpBtn.setAttribute('aria-expanded', 'true');
    helpOpen = true;
    helpOutsideListener = (e) => { if (!elHelp.contains(e.target) && e.target !== elHelpBtn){ closeHelp(); } };
    helpEscListener = (e) => { if (e.key === 'Escape') closeHelp(); };
    document.addEventListener('mousedown', helpOutsideListener);
    document.addEventListener('keydown', helpEscListener);
  }
  function closeHelp(){
    if (!helpOpen || !elHelp || !elHelpBtn) return;
    elHelp.classList.add('hidden');
    elHelpBtn.setAttribute('aria-expanded', 'false');
    helpOpen = false;
    document.removeEventListener('mousedown', helpOutsideListener);
    document.removeEventListener('keydown', helpEscListener);
  }
  if (elHelpBtn && elHelp && elHelpClose) {
    elHelpBtn.addEventListener('click', () => { helpOpen ? closeHelp() : openHelp(); });
    elHelpClose.addEventListener('click', closeHelp);
  }

  selectWorkingDay();
})();
  </script>

  <!-- Usage (HTMX) wiring for Plotly chart -->
  <script>
(() => {
  const $ = (s) => document.querySelector(s);
  const $$ = (s) => Array.from(document.querySelectorAll(s));

  const controls = $('#usageControls');
  const plot = $('#usagePlot');
  const err = $('#usageErr');
  const errMsg = $('#usageErrMsg');

  if (!controls || !plot) return;

  let currentView = 'electricity';
  let currentRange = 'day';

  function setSegActive(btn){
    if (!btn) return;
    const group = btn.closest('.seg');
    group.querySelectorAll('.seg-btn').forEach(b => { b.classList.remove('active'); b.setAttribute('aria-pressed','false'); b.setAttribute('aria-selected','false'); });
    btn.classList.add('active'); btn.setAttribute('aria-pressed','true'); btn.setAttribute('aria-selected','true');
  }

  function templateUrl(){
    const tpl = controls.getAttribute('data-url-template') || '';
    // Replace only the placeholders we inserted in the Django URL helper
    return tpl.replace('/RANGE/', `/${currentRange}/`).replace('/VIEW/', `/${currentView}/`);
  }

  function runInlineScripts(container){
    const scripts = Array.from(container.querySelectorAll('script'));
    for (const old of scripts) {
      const s = document.createElement('script');
      if (old.src) {
        s.src = old.src;
      } else {
        s.textContent = old.textContent;
      }
      // Carry over attributes Plotly uses (type, etc.)
      Array.from(old.attributes).forEach(a => s.setAttribute(a.name, a.value));
      old.replaceWith(s);
    }
  }

  async function refresh(){
    try{
      if (err) err.classList.add('hidden');
      const url = templateUrl();
      const resp = await fetch(url, { headers: { 'HX-Request': 'true' }, cache: 'no-store' });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const html = await resp.text();
      plot.innerHTML = html;
  +   runInlineScripts(plot); // ensure Plotly’s inline script executes
      // Plotly JS is already included in initial div via CDN; the partials do not include it again.
    }catch(e){
      if (errMsg) errMsg.textContent = `Unable to load usage (${e.message}).`;
      if (err) err.classList.remove('hidden');
    }
  }

  controls.addEventListener('click', (e) => {
    const btn = e.target.closest('.seg-btn'); if (!btn) return;
    if (btn.dataset.view){
      currentView = btn.dataset.view;
      setSegActive(btn);
      refresh();
    }
    if (btn.dataset.range){
      currentRange = btn.dataset.range;
      setSegActive(btn);
      refresh();
    }
  });

  const retry = document.getElementById('usageRetry');
  if (retry) retry.addEventListener('click', refresh);

  // Help popover
  const elUsageHelpBtn = document.getElementById('usageHelpBtn');
  const elUsageHelp = document.getElementById('usageHelp');
  const elUsageHelpClose = document.getElementById('usageHelpClose');
  let open = false, outside=null, esc=null;
  function openHelp(){
    if (open || !elUsageHelp) return;
    elUsageHelp.classList.remove('hidden');
    elUsageHelpBtn.setAttribute('aria-expanded','true');
    open = true;
    outside = (evt) => { if (!elUsageHelp.contains(evt.target) && evt.target !== elUsageHelpBtn) closeHelp(); };
    esc = (evt) => { if (evt.key === 'Escape') closeHelp(); };
    document.addEventListener('mousedown', outside);
    document.addEventListener('keydown', esc);
  }
  function closeHelp(){
    if (!open || !elUsageHelp) return;
    elUsageHelp.classList.add('hidden');
    elUsageHelpBtn.setAttribute('aria-expanded','false');
    open = false;
    document.removeEventListener('mousedown', outside);
    document.removeEventListener('keydown', esc);
  }
  if (elUsageHelpBtn && elUsageHelp && elUsageHelpClose) {
    elUsageHelpBtn.addEventListener('click', () => open ? closeHelp() : openHelp());
    elUsageHelpClose.addEventListener('click', closeHelp);
  }
})();
  </script>

<script>
  (() => {
    // Constants for equivalencies (tweak as needed)
    const W_BULB = 60;
    const W_LAPTOP = 65;
    const KETTLE_KWH = 0.11;
    const TREE_KG_PER_YEAR = 21;
    const CAR_KG_PER_KM = 0.12;
    const FLIGHT_KG = 600;
  
    const $ = (s) => document.querySelector(s);
    const fmt = (n, d=2) => Number(n).toLocaleString(undefined, {minimumFractionDigits:d, maximumFractionDigits:d});
    const fmtInt = (n) => Math.round(n).toLocaleString();
  
    function setSummaryHeader(view){
      const title = $('#summaryTitle');
      const unit  = $('#sumUnit');
      if (!title || !unit) return;
      if (view === 'carbon'){
        title.textContent = 'Carbon summary';
        unit.textContent = 'kg CO₂e';
      } else {
        title.textContent = 'Electricity summary';
        unit.textContent = 'kWh';
      }
    }
  
    function setSummaryTotals(view, total, avg, bins){
      const totalEl = $('#sumTotal');
      const avgEl   = $('#sumAvgPerBin');
      const binsEl  = $('#sumBins');
      if (totalEl) totalEl.textContent = fmt(total, view === 'carbon' ? 2 : 2);
      if (avgEl)   avgEl.textContent   = fmt(avg,   view === 'carbon' ? 2 : 2);
      if (binsEl)  binsEl.textContent  = String(bins ?? '–');
    }
  
    function setSummaryExtrema(view, maxVal, maxLabel, minVal, minLabel){
      const pVal = $('#sumPeakVal'), pLab = $('#sumPeakLabel');
      const mVal = $('#sumMinVal'),  mLab = $('#sumMinLabel');
      const dps  = view === 'carbon' ? 2 : 2;
      if (pVal) pVal.textContent = (maxVal == null) ? '–' : fmt(maxVal, dps);
      if (mVal) mVal.textContent = (minVal == null) ? '–' : fmt(minVal, dps);
      if (pLab) pLab.textContent = maxLabel || '–';
      if (mLab) mLab.textContent = minLabel || '–';
    }
  
    function showEquivalencies(view){
      const eqE = $('#eqElectricity');
      const eqC = $('#eqCarbon');
      if (!eqE || !eqC) return;
      if (view === 'carbon'){
        eqE.style.display = 'none';
        eqC.style.display = '';
      } else {
        eqE.style.display = '';
        eqC.style.display = 'none';
      }
    }
  
    // Electricity equivalents
    function updateElectricity(totalKwh, avgKwh) {
      const bulbH   = (totalKwh / (W_BULB/1000));
      const laptopH = (totalKwh / (W_LAPTOP/1000));
      const boils   = (totalKwh / KETTLE_KWH);
  
      const elTotal = $('#eqElecTotal');
      if (elTotal) elTotal.innerHTML = `<strong>${fmt(totalKwh, 2)} kWh</strong> total`;
  
      const elBulb  = $('#bulbHours');
      const elLap   = $('#laptopHours');
      const elKet   = $('#kettleBoils');
  
      if (elBulb) elBulb.textContent = `≈ ${fmtInt(bulbH)} light-bulb hours (60W)`;
      if (elLap)  elLap.textContent  = `≈ ${fmtInt(laptopH)} laptop hours (65W)`;
      if (elKet)  elKet.textContent  = `≈ ${fmtInt(boils)} kettle boils (0.11 kWh/boil)`;
    }
  
    // Carbon equivalents
    function updateCarbon(totalKg, avgKg) {
      const treeYears = totalKg / TREE_KG_PER_YEAR;
      const carKm     = totalKg / CAR_KG_PER_KM;
      const flightPct = (totalKg / FLIGHT_KG) * 100;
  
      const elTotal      = $('#carbonTotalKg');
      const elTrees      = $('#treeYears');
      const elCarKm      = $('#carKm');
      const elFlightPct  = $('#flightPct');
  
      if (elTotal)    elTotal.textContent    = fmt(totalKg, 2);
      if (elTrees)    elTrees.textContent    = `≈ ${totalKg < TREE_KG_PER_YEAR ? treeYears.toFixed(2) : fmt(treeYears, 2)} tree-years`;
      if (elCarKm)    elCarKm.textContent    = `≈ ${fmtInt(carKm)} car km`;
      if (elFlightPct)elFlightPct.textContent= `≈ ${flightPct < 1 ? flightPct.toFixed(2) : fmt(flightPct, 1)}% of a Paris→Dubai flight`;
    }
  
    // New: a single entrypoint that also accepts extrema + unit info.
    // Signature: (view, total, avg, bins, maxVal, maxLabel, minVal, minLabel)
    window.updateUsageMetrics = function(view, total, avg, bins, maxVal, maxLabel, minVal, minLabel){
      setSummaryHeader(view);
      setSummaryTotals(view, total, avg, bins);
      setSummaryExtrema(view, maxVal, maxLabel, minVal, minLabel);
      showEquivalencies(view);
  
      if (view === 'electricity') updateElectricity(total, avg);
      if (view === 'carbon')      updateCarbon(total,   avg);
    };
  })();
  </script>

  <!-- Workspace figures script (unchanged) -->
  <script>
  (() => {
    const $$ = (s) => Array.from(document.querySelectorAll(s));
    const fmt = (n, d=2) => Number(n).toLocaleString(undefined, { minimumFractionDigits:d, maximumFractionDigits:d });
  
    $$('.ws-figures').forEach((el) => {
      const totalK = parseFloat(el.dataset.totalKwh || '0');
      const idleK  = parseFloat(el.dataset.idleKwh  || '0');
      const totalG = parseFloat(el.dataset.totalKg  || '0');
      const idleG  = parseFloat(el.dataset.idleKg   || '0');
      const idleW  = parseFloat(el.dataset.idleW    || '0');
      const ci     = parseFloat(el.dataset.ci       || '220');
  
      const kBar = el.querySelector('.figure-bar[data-kind="kwh"]');
      const gBar = el.querySelector('.figure-bar[data-kind="kg"]');
      const kPct = totalK > 0 ? (idleK / totalK) * 100 : 0;
      const gPct = totalG > 0 ? (idleG / totalG) * 100 : 0;
      if (kBar) kBar.style.setProperty('--pct', kPct + '%');
      if (gBar) gBar.style.setProperty('--pct', gPct + '%');
  
      const elK = el.querySelector('.idle-kwh-counter');
      const elG = el.querySelector('.idle-kg-counter');
  
      // Live idle counters (increment each second using idleW)
      const incrKwh = (idleW / 1000) / 3600;   // kWh per second
      const incrKg  = incrKwh * (ci / 1000);   // kg CO2e per second
  
      let kwh = 0, kg = 0;
      function tick() {
        kwh += incrKwh;
        kg  += incrKg;
        if (elK) elK.textContent = fmt(kwh, 3);
        if (elG) elG.textContent = fmt(kg, 4);
      }
      tick();
      setInterval(tick, 1000);
    });
  })();
  </script>
  
</body>
</html>
