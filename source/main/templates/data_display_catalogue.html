{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{{ page_title }}</title>
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <style>
    /* page-specific light styles */
    .catalogue-wrap { display: grid; gap: 20px; }
    .catalogue-section { background:#fff; border:1px solid #e0e0e0; border-radius:6px; padding:16px; }
    .catalogue-title { font-size:16px; font-weight:600; color:#37474f; margin:0 0 8px; display:flex; align-items:center; gap:8px; }
    .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    .grid-3 { display:grid; grid-template-columns:repeat(3,1fr); gap:16px; }
    .mini-row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .pill { border:1px solid #e0e0e0; border-radius:18px; padding:6px 10px; font-size:12px; cursor:pointer; background:#fff; }
    .pill.active { box-shadow: inset 0 0 0 999px #f5f5f5; }
    .kpi { background:#fafafa; border:1px solid #eee; border-radius:6px; padding:10px 12px; }
    .kpi .big { font-size:18px; font-weight:700; color:#263238; }
    canvas { width:100%; height:280px; }
    @media (max-width: 900px) { .grid-2, .grid-3 { grid-template-columns:1fr; } }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header class="top-nav">
    <div class="left">
      <img src="{% static 'images/small_atom.png' %}" alt="" class="small-icon">
      <span class="analysis-title">Data Display Catalogue</span>
    </div>
    <div class="right"><a class="logout-link" href="{% url 'home' %}">Home</a></div>
  </header>

  <div class="page-body">
    <nav class="sidebar">
      <ul>
        <li><img src="{% static 'images/icon_workspaces.png' %}" alt="">Workspaces</li>
        <li><img src="{% static 'images/icon_data.png' %}" alt="">Data</li>
        <li><img src="{% static 'images/icon_experiments.png' %}" alt="">Experiments</li>
        <li><img src="{% static 'images/icon_question.png' %}" alt="">Help</li>
        <li><img src="{% static 'images/icon_info.png' %}" alt="">About</li>
      </ul>
    </nav>

    <main class="content">
      <div class="catalogue-wrap">

        <!-- Virtual Capacity Curves -->
        <section class="catalogue-section">
          <h3 class="catalogue-title">Virtual Capacity Curves</h3>
          <div class="grid-2">
            <div>
              <div class="mini-row"><span class="pill active">Electricity view</span></div>
              <canvas id="capElectricity"></canvas>
            </div>
            <div>
              <div class="mini-row"><span class="pill active">Carbon view</span></div>
              <canvas id="capCarbon"></canvas>
            </div>
          </div>
        </section>

        <!-- Carbon Intensity Forecast -->
        <section class="catalogue-section">
          <h3 class="catalogue-title">Carbon Intensity Forecast</h3>
          <canvas id="ciForecast"></canvas>
        </section>

        <!-- Project usage (with range selector + footprint/equivalency) -->
        <section class="catalogue-section">
          <h3 class="catalogue-title">Estimated Electricity Usage (Project)</h3>
          <div class="mini-row" id="projRangeBtns">
            <button class="pill active" data-range="day">Day</button>
            <button class="pill" data-range="month">Month</button>
            <button class="pill" data-range="year">Year</button>
          </div>
          <div class="grid-3" style="margin-top:12px;">
            <div class="kpi"><div>Carbon footprint</div><div class="big" id="projFootprint">—</div></div>
            <div class="kpi"><div>Equivalency</div><div id="projEquiv">—</div></div>
            <div class="kpi"><div>SCI Score</div><div class="big" id="projSCI">—</div></div>
          </div>
          <canvas id="projUsage"></canvas>
        </section>

        <!-- SCI / GHG Scores -->
        <section class="catalogue-section">
          <h3 class="catalogue-title">Scores</h3>
          <div class="grid-2">
            <div>
              <div class="mini-row"><span class="pill active">SCI Score</span></div>
              <canvas id="sciScore"></canvas>
            </div>
            <div>
              <div class="mini-row"><span class="pill active">GHG Score</span></div>
              <canvas id="ghgScore"></canvas>
            </div>
          </div>
        </section>

        <!-- Workspace figures -->
        <section class="catalogue-section">
          <h3 class="catalogue-title">Workspace Figures</h3>
          <div class="grid-2">
            <div>
              <div class="mini-row"><span class="pill active">Idle Usage Counter per workspace</span></div>
              <canvas id="idleUsage"></canvas>
            </div>
            <div>
              <div class="mini-row"><span class="pill active">Best time (8–5) by carbon intensity</span></div>
              <canvas id="bestTime"></canvas>
            </div>
          </div>
        </section>

        <!-- Service figures -->
        <section class="catalogue-section">
          <h3 class="catalogue-title">Service Figures</h3>
          <div class="mini-row" id="svcRangeBtns">
            <button class="pill active" data-range="day">Day</button>
            <button class="pill" data-range="month">Month</button>
            <button class="pill" data-range="year">Year</button>
          </div>
          <div class="grid-3" style="margin-top:12px;">
            <div class="kpi"><div>Carbon footprint</div><div class="big" id="svcFootprint">—</div></div>
            <div class="kpi"><div>Equivalency</div><div id="svcEquiv">—</div></div>
            <div class="kpi"><div>GHG Score</div><div class="big" id="svcGHG">—</div></div>
          </div>
          <canvas id="svcUsage"></canvas>
        </section>

      </div>
    </main>
  </div>

  <script>
    // helper: random-ish series with a seed so it's repeatable
    function seeded(seed){let x = Math.sin(seed) * 10000;return x - Math.floor(x);}
    function series(n, base=50, amp=20, seed=1){const d=[];for(let i=0;i<n;i++){seed+=i+1;d.push(Math.round(base + (seeded(seed)-0.5)*2*amp));}return d;}

    // base chart options (no legends clutter)
    const optsLine = {responsive:true, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}, y:{grid:{color:'#eee'}}}};
    const optsBar  = {responsive:true, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}, y:{grid:{color:'#eee'}}}};
    const ringOpts = {responsive:true, plugins:{legend:{display:false}}, cutout:'70%'};

    // Virtual Capacity Curves
    new Chart(document.getElementById('capElectricity'), {
      type:'line',
      data:{ labels:[...Array(24).keys()].map(h=>`${h}:00`),
        datasets:[{ data: series(24, 60, 25, 2), borderWidth:2, fill:false }] },
      options: optsLine
    });
    new Chart(document.getElementById('capCarbon'), {
      type:'line',
      data:{ labels:[...Array(24).keys()].map(h=>`${h}:00`),
        datasets:[{ data: series(24, 300, 120, 3), borderWidth:2, fill:false }] },
      options: optsLine
    });

    // Carbon Intensity Forecast (next 24h)
    new Chart(document.getElementById('ciForecast'), {
      type:'line',
      data:{ labels:[...Array(24).keys()].map(h=>`${h}:00`),
        datasets:[{ data: series(24, 250, 140, 5), borderWidth:2, fill:false }] },
      options: optsLine
    });

    // Project Usage (range selector)
    const projCtx = document.getElementById('projUsage');
    const proj = new Chart(projCtx, { type:'bar', data:{labels:[], datasets:[{data:[]}]}, options:optsBar });
    function loadProject(range){
      const map = {
        day:   { labels:[...Array(24).keys()].map(h=>`${h}:00`), n:24, base:2, amp:1, ciBase:220 },
        month: { labels:[...Array(30).keys()].map(d=>`D${d+1}`), n:30, base:50, amp:20, ciBase:230 },
        year:  { labels:['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'], n:12, base:600, amp:200, ciBase:240 }
      };
      const cfg = map[range];
      const kWh = series(cfg.n, cfg.base, cfg.amp, 7);
      proj.data.labels = cfg.labels;
      proj.data.datasets[0].data = kWh;
      proj.update();

      // dummy footprint + equivalency + SCI
      const totalKWh = kWh.reduce((a,b)=>a+b,0);
      const gCO2perkWh = cfg.ciBase;            // pretend CI baseline varies a bit by range
      const kgCO2 = Math.round(totalKWh * gCO2perkWh / 1000);
      document.getElementById('projFootprint').textContent = `${kgCO2.toLocaleString()} kg CO₂e`;
      document.getElementById('projEquiv').textContent = `≈ ${(kgCO2/120).toFixed(1)} trees / yr`;
      document.getElementById('projSCI').textContent = (80 - (kgCO2 % 30)).toFixed(0);
    }
    loadProject('day');
    document.getElementById('projRangeBtns').addEventListener('click', (e)=>{
      if(e.target.matches('.pill')) {
        [...e.currentTarget.children].forEach(b=>b.classList.remove('active'));
        e.target.classList.add('active');
        loadProject(e.target.dataset.range);
      }
    });

    // SCI & GHG Scores (rings)
    new Chart(document.getElementById('sciScore'), {
      type:'doughnut',
      data:{ labels:['score','rest'], datasets:[{ data:[72, 28] }] },
      options: ringOpts
    });
    new Chart(document.getElementById('ghgScore'), {
      type:'doughnut',
      data:{ labels:['score','rest'], datasets:[{ data:[64, 36] }] },
      options: ringOpts
    });

    // Workspace figures
    new Chart(document.getElementById('idleUsage'), {
      type:'bar',
      data:{ labels:['Workspace 1','Workspace 2','Workspace 3','Workspace 4'],
        datasets:[{ data:[12,7,4,15] }] },
      options: optsBar
    });
    new Chart(document.getElementById('bestTime'), {
      type:'bar',
      data:{ labels:['8','9','10','11','12','13','14','15','16','17'],
        datasets:[{ data: [70,65,60,55,50,48,52,58,66,74] }] },
      options: optsBar
    });

    // Service figures (range selector)
    const svcCtx = document.getElementById('svcUsage');
    const svc = new Chart(svcCtx, { type:'bar', data:{labels:[], datasets:[{data:[]}]}, options:optsBar });
    function loadService(range){
      const map = {
        day:   { labels:[...Array(24).keys()].map(h=>`${h}:00`), n:24, base:8, amp:3 },
        month: { labels:[...Array(30).keys()].map(d=>`D${d+1}`), n:30, base:200, amp:90 },
        year:  { labels:['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'], n:12, base:2500, amp:800 }
      };
      const cfg = map[range];
      const kWh = series(cfg.n, cfg.base, cfg.amp, 12);
      svc.data.labels = cfg.labels;
      svc.data.datasets[0].data = kWh;
      svc.update();

      const kgCO2 = Math.round(kWh.reduce((a,b)=>a+b,0) * 0.25); // arbitrary factor
      document.getElementById('svcFootprint').textContent = `${kgCO2.toLocaleString()} kg CO₂e`;
      document.getElementById('svcEquiv').textContent = `≈ ${(kgCO2/120).toFixed(1)} trees / yr`;
      document.getElementById('svcGHG').textContent = (70 - (kgCO2 % 20)).toFixed(0);
    }
    loadService('day');
    document.getElementById('svcRangeBtns').addEventListener('click', (e)=>{
      if(e.target.matches('.pill')) {
        [...e.currentTarget.children].forEach(b=>b.classList.remove('active'));
        e.target.classList.add('active');
        loadService(e.target.dataset.range);
      }
    });
  </script>
</body>
</html>
